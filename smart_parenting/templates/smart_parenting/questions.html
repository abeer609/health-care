{% extends 'smart_parenting/base.html' %}
{% block content %}
<div class="mx-auto max-w-4xl">

    <form action="" method="post">
        {% csrf_token %}
        {% for q in questions %}
        <div class="py-4">
            <div class="">
                <div class="overflow-hidden rounded-lg bg-white shadow-sm">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="relative overflow-hidden rounded-sm opacity-75">
                            <p class="mb-2">{{q.title}}</p>
                            <div class="flex gap-4">
                                <div>
                                    <label><input type="radio" name="{{q.id}}" value="True"> Yes</label>
                                </div>
                                <div>
                                    <label><input required type="radio" name="{{q.id}}" value="False"> No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <button id="submit_form" type="submit"
            class="flex justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Submit
        </button>

    </form>
    <div x-data @keydown.window.escape="$store.modal.open = false" x-show="$store.modal.open" class="relative z-10"
        aria-labelledby="modal-title" x-ref="dialog" aria-modal="true">

        <div x-show="$store.modal.open" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
            x-description="Background backdrop, show/hide based on modal state."
            class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>


        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">

                <div x-show="$store.modal.open" x-transition:enter="ease-out duration-300"
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave="ease-in duration-200"
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    x-description="Modal panel, show/hide based on modal state."
                    class="relative transform overflow-hidden rounded-lg bg-white px-4 pt-5 pb-4 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6"
                    @click.away="$store.modal.open = false">
                    <div class="sm:flex sm:items-start">
                        
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-base font-semibold text-gray-900" id="modal-title" x-text="$store.modal.message"></h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500" x-text="$store.modal.description"></p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button"
                            class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 shadow-xs ring-gray-300 ring-inset hover:bg-gray-50 sm:mt-0 sm:w-auto"
                            @click="$store.modal.open = false">Cancel</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block script %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(
                        cookie.substring(name.length + 1)
                    );
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('alpine:init', () => {
        Alpine.store('modal', {
            open: false,
            message: "",
            description: ""
        })
    });

    const btn = document.getElementById("submit_form")


    const submitForm = async (data) => {
        const csrftoken = getCookie("csrftoken");
        const request = await fetch("", {
            method: "POST",
            body: JSON.stringify(data),
            headers: {
                "X-CSRFToken": csrftoken,
                Accept: "application/json",
                "Content-Type": "application/json",
            },
        });
        return request
    }

    document.addEventListener('alpine:initialized', () => {
        btn.onclick = (e) => {
            e.preventDefault()
            const inpts = document.querySelectorAll('input[type="radio"]:checked')
            const responses = []
            for (inp of inpts) {
                const question_id = inp.name
                const response = inp.value
                responses.push({ question_id, response })
            }

            submitForm(responses).then(res => {
                res.json().then(r => {
                    if(r.risk == "LOW"){
                        Alpine.store('modal').message = "Low Risk"
                        Alpine.store('modal').description = "Your child's responses show minimal or no signs of developmental concerns related to autism. Most social, communication, and behavioral skills appear age-appropriate. Continue to monitor your child's growth and development during regular check-ups. Keep engaging in interactive play, reading, and conversations to support communication and social skills. "
                    }else if(r.risk=="MODERATE"){
                        Alpine.store('modal').message = "Moderate Risk"
                        Alpine.store('modal').description = "Some responses indicate possible delays or behaviors linked to autism spectrum traits. While these signs do not confirm autism, they suggest closer observation is warranted. Discuss your observations with a pediatrician or child development specialist. Track behaviors over time and provide opportunities for social interaction, language practice, and play. Early support can make a significant difference."
                    }else if(r.risk == "HIGH"){
                        Alpine.store('modal').message = "High Risk"
                        Alpine.store('modal').description = "Several responses suggest notable developmental differences that align with autism spectrum traits. These may include challenges in communication, social engagement, or repetitive behaviors. Seek a comprehensive evaluation from a pediatrician or a licensed autism specialist as soon as possible. Early diagnosis and intervention can greatly improve developmental outcomes. Consider connecting with local early intervention programs and support services."
                    }
                    Alpine.store('modal').open = true
                })
            })
            console.log(responses)
        }
    })
</script>
{% endblock %}